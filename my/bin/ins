#!/bin/bash

lsb_release -a | grep Manjaro 1>/dev/null 2>&1
manjaro=$?
lsb_release -a | grep Ubuntu 1>/dev/null 2>&1
ubuntu=$?

if [[ "$HOME" == "" ]]; then
	if [[ "$(whoami)" == "root" ]]; then
		HOME=/root
	else
		HOME=/home/$(whoami)
	fi
fi

function usage() {
	cat <<- _EOF_
		install
		remove
		reinstall
		list
	_EOF_
}

function get_function() {
	cmd="egrep \"function [a-zA-Z0-9_]+\(\) {\" $0"
	cmd="$cmd | cut -d ' ' -f 2 | cut -d '(' -f 1"
	eval $cmd
}

function usage_install() {
	get_function | egrep "^install" | sed "s/install_/install /g"
}

function usage_remove() {
	get_function | egrep "^remove" | sed "s/remove_/remove /g"
}

function usage_reinstall() {
	get_function | egrep "^reinstall" | sed "s/reinstall_/reinstall /g"
}

function usage_list() {
	echo "install:"
	usage_install
	echo -e "\nremove:"
	usage_remove
	echo -e "\nreinstall:"
	usage_reinstall
}

function check_retval() {
	if [[ $? != 0 ]]; then
		echo "ins: $1 failed"
		exit $?
	fi
}

function need_dir() {
	dir_name=$1
	if [ ! -d $dir_name ]; then
		mkdir $dir_name
		check_retval "need dir: $dir_name"
	fi
}

function check_dir() {
	dir_name=$1
	if [ -d $dir_name ]; then
		echo "already exist dir: $dir_name"
		exit 1
	fi
}

function reinstall_zsh_powerlevel9k() {
	remove_zsh_powerlevel9k
	install_zsh_powerlevel9k
}

function remove_zsh_powerlevel9k() {
	need_dir $HOME/my/src
	rm -rf $HOME/my/src/powerlevel9k
	check_retval "rm -rf $HOME/my/src/powerlevel9k"
}

function reinstall_zsh_dracula() {
	remove_zsh_dracula
	install_zsh_dracula
}

function remove_zsh_dracula() {
	need_dir $HOME/my/src
	rm -rf $HOME/my/src/zsh_dracula
	check_retval "rm -rf $HOME/my/src/zsh_dracula"
}

function reinstall_zsh_autosuggestions() {
	remove_zsh_autosuggestions
	install_zsh_autosuggestions
}

function remove_zsh_autosuggestions() {
	rm -rf $HOME/.oh-my-zsh/plugins/zsh-autosuggestions
}

function remove_nodejs() {
	need_dir $HOME/my/src
	rm -rf $HOME/my/src/nodejs
	check_retval "rm -rf $HOME/my/src/nodejs"
	sudo rm /usr/bin/npm /usr/bin/node
}

function install_rg() {
	curl https://sh.rustup.rs -sSf | sh
	source $HOME/.cargo/env
	git clone https://github.com/BurntSushi/ripgrep ~/my/src/
	cd ~/my/src/ripgrep
	cargo build --release
}

function install_aptitude() {
	sudo apt install aptitude
	check_retval "sudo apt install aptitude"

	sudo aptitude install cscope ctags fontconfig aria2
	check_retval "sudo aptitude install cscope ctags fontconfig aria2"
}

function install_zsh_h() {
	git clone git@github.com:paoloantinori/hhighlighter.git $HOME/.oh-my-zsh/plugins/h
	mv $HOME/.oh-my-zsh/plugins/h/h.sh $HOME/.oh-my-zsh/plugins/h/h.plugin.zsh
}

function install_lazygit() {
	if [[ "$ubuntu" == "0" ]]; then
		sudo add-apt-repository -yu ppa:lazygit-team/release
		sudo aptitude install lazygit
	fi
}

function install_manjaro() {
	cat <<- _EOF_
	sudo echo -en "[archlinuxcn]\nSigLevel = Never\nServer = https://mirrors.tuna.tsinghua.edu.cn/archlinuxcn/$arch" >> /etc/pacman.conf
	_EOF_
}

function main() {
	if [[ $1 == "" ]]; then
		usage
		exit 0
	fi

	if [[ $2 == "" ]]; then
		eval usage_$1
		exit 0
	fi

	eval $1_$2
}

main $*

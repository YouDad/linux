#!/bin/bash

if [[ "$HOME" == "" ]]; then
	if [[ "$(whoami)" == "root" ]]; then
		HOME=/root
	else
		HOME=/home/$(whoami)
	fi
fi

function usage() {
	cat <<- _EOF_
		install
		reinstall
		list
	_EOF_
}

function usage_install() {
	cat <<- _EOF_
		install <name>
	_EOF_
}

function usage_reinstall() {
	cat <<- _EOF_
		reinstall <name>
	_EOF_
}

function usage_list() {
	cmd="egrep \"function [a-zA-Z0-9_]+\(\) {\" $0"
	cmd="$cmd | cut -d ' ' -f 2 | cut -d '(' -f 1"
	echo "install:"
	eval $cmd | egrep "^install" | sed "s/install_/install /g"
	echo -e "\nreinstall:"
	eval $cmd | egrep "^reinstall" | sed "s/reinstall_/reinstall /g"
}

function check_retval() {
	if [[ $? != 0 ]]; then
		echo "ins: $1 failed"
		exit $?
	fi
}

function need_dir() {
	dir_name=$1
	if [ ! -d $dir_name ]; then
		mkdir $dir_name
		check_retval "need dir: $dir_name"
	fi
}

function check_dir() {
	dir_name=$1
	if [ -d $dir_name ]; then
		echo "already exist dir: $dir_name"
		exit 1
	fi
}

function reinstall_zsh_dracula() {
	need_dir $HOME/src
	rm -rf $HOME/src/zsh_dracula
	install_zsh_dracula
}

function install_zsh_dracula() {
	path=$HOME/src/zsh_dracula
	need_dir $HOME/src
	check_dir $path

	git clone https://github.com/dracula/zsh.git $path
	check_retval "git clone https://github.com/dracula/zsh.git $path"

	ln -sf $path/dracula.zsh-theme $HOME/.oh-my-zsh/theme/dracula.zsh-theme
	check_retval "ln -sf $path/dracula.zsh-theme $HOME/.oh-my-zsh/theme/dracula.zsh-theme"
}

function reinstall_nodejs() {
	need_dir $HOME/src
	rm -rf $HOME/src/nodejs
	install_nodejs
}

function install_nodejs() {
	need_dir $HOME/src
	check_dir $HOME/src/nodejs
	url=https://npm.taobao.org/mirrors/node/v12.10.0/node-v12.10.0-linux-x64.tar.xz

	wget $url
	check_retval "wget $url"

	tar -axvf node-v12.10.0-linux-x64.tar.xz
	check_retval "tar -axvf node-v12.10.0-linux-x64.tar.xz"

	mv node-v12.10.0-linux-x64 nodejs
	check_retval "mv node-v12.10.0-linux-x64 nodejs"

	mv nodejs $HOME/src
	check_retval "mv nodejs $HOME/src"

	sudo ln -s $HOME/src/nodejs/bin/npm /usr/bin/
	check_retval "sudo ln -s $HOME/src/nodejs/bin/npm /usr/bin/"

	sudo ln -s $HOME/src/nodejs/bin/node /usr/bin/
	check_retval "sudo ln -s $HOME/src/nodejs/bin/node /usr/bin/"

	rm node-v12.10.0-linux-x64.tar.xz
	check_retval "rm node-v12.10.0-linux-x64.tar.xz"
}

function install_aptitude() {
	sudo apt install aptitude
	check_retval "sudo apt install aptitude"

	sudo aptitude install cscope ctags
	check_retval "sudo aptitude install cscope ctags"
}

function main() {
	if [[ $1 == "" ]]; then
		usage
		exit 0
	fi

	if [[ $2 == "" ]]; then
		eval usage_$1
		exit 0
	fi

	eval $1_$2
}

main $*
